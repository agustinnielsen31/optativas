<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Optativas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 60px auto;
      background: #f9fafc;
      color: #333;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      font-size: 1.6em;
      margin-bottom: 20px;
    }

    .intro {
      background-color: #eef3ff;
      border-left: 4px solid #007bff;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      font-size: 1em;
    }

    .intro-collapsible { position: relative; }
    .intro-content {
      --preview-lines: 6;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: var(--preview-lines);
      overflow: hidden;
      position: relative;
    }
    .intro-collapsible:not([data-expanded="true"]) .intro-content::after {
      content: "";
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 3rem;
      background: linear-gradient(to bottom, rgba(238,243,255,0), var(--intro-fade, #eef3ff));
      pointer-events: none;
    }
    .intro-collapsible[data-expanded="true"] .intro-content {
      -webkit-line-clamp: unset;
      overflow: visible;
    }

    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
    }

    input[type="number"], input[type="range"] {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .range-value {
      text-align: right;
      font-size: 0.9em;
      color: #555;
      margin-top: 4px;
    }

    button {
      display: block;
      width: 100%;
      margin-top: 25px;
      padding: 10px;
      font-size: 1.1em;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #0056b3;
    }

    .intro-toggle {
      margin-top: 10px;
      display: inline-block;
      width: auto;
      background: transparent;
      color: #007bff;
      border: 1px solid #007bff;
      border-radius: 6px;
      padding: .4rem .75rem;
      cursor: pointer;
      font: inherit;
    }

    .intro-toggle:hover { background-color: rgba(0, 123, 255, 0.08); }
    .intro-toggle:focus { outline: 2px solid #666; outline-offset: 2px; }

    .resultados {
      margin-top: 30px;
      padding: 15px;
      background-color: #eef3ff;
      border-radius: 8px;
      font-size: 1.1em;
    }

    .resultado-item { margin-top: 10px; }

    .insustentable {
      color: #d40000;
      font-weight: bold;
      margin-top: 15px;
      font-size: 1.1em;
    }

    .footer-link {
      margin-top: 35px;
      text-align: center;
      font-size: 0.95em;
    }

    .footer-link a {
      color: #007bff;
      text-decoration: none;
    }

    .footer-link a:hover { text-decoration: underline; }

    @keyframes alertPulseBg {
      0%   { background-color: #ffe1e1; }
      50%  { background-color: #fff3c4; }
      100% { background-color: #ffe1e1; }
    }
    body.alert-bg-animating { animation: alertPulseBg 1.2s ease-in-out infinite; }

    /* === ESTILOS DE LAS ENCUESTAS === */
    #encuestas {
      margin-top: 60px;
      border-top: 2px solid #ccc;
      padding-top: 40px;
    }
    .pregunta { text-align:center; margin-bottom:50px; }
    .pregunta h3 { font-weight:normal; margin-bottom:15px; }
    .botones button {
      background:#007bff;
      color:white;
      border:none;
      padding:10px 20px;
      border-radius:6px;
      cursor:pointer;
      margin:5px;
    }
    .botones button:hover { background:#0056b3; }
    canvas {
      display:block;
      margin:15px auto;
      border:1px solid #ddd;
      border-radius:8px;
    }
    .porcentajes { font-weight:bold; margin-top:5px; }
    .total-respuestas {
      margin-top: 8px;
      font-size: 0.9em;
      color: #666;
      font-style: italic;
    }
  </style>
</head>

<body>
  <h1>Calculadora de Estudiantes por Optativa (Un cuatrimestre)</h1>

  <div class="intro intro-collapsible" id="intro" data-expanded="false" style="--intro-fade:#eef3ff;">
    <div class="intro-content" id="intro-content">
      En el nuevo plan de estudios propuesto por la direcci√≥n de la carrera se marca una diferencia entre <strong>"Materias Electivas"</strong> y <strong>"Materias Optativas"</strong>.<br><br>
      Las Electivas est√°n determinadas en el plan de estudios, son 35 y se espera que tengan c√°tedras paralelas as√≠ como tambi√©n re√∫nan equipos de c√°tedra. Podr√°n cursarse un m√°ximo de 8 y un m√≠nimo de 6.<br><br>
      Las Optativas son de oferta renovable y de programa "libre", tal como las actuales. Podr√°n cursarse un m√°ximo de 2 y un m√≠nimo de 0. Representan como m√°ximo un 25% (8/2) de las materias de elecci√≥n libre y un 0% como m√≠nimo.<br><br>
      Si una materia optativa no tiene m√°s de 4 inscriptos durante dos cuatrimestres esa c√°tedra se cierra.<br><br>
      <strong>¬øEl esquema que propone el plan actual es sustentable para las optativas?</strong> Esta calculadora permite averiguarlo teniendo en cuenta tres variables: cantidad de estudiantes en el tramo de elecci√≥n libre, participaci√≥n de optativas en la demanda y total de materias optativas.<br><br>
      Por ejemplo, si hay 300 estudiantes y el 20% hace materias optativas, eso nos deja con 60 estudiantes que cursar√°n optativas. Si hay 20 c√°tedras de materias optativas entonces, como m√≠nimo cada c√°tedra podr√° tener 3 estudiantes (60/20 = 3), por lo cual el esquema ser√≠a insustentable.
    </div>
    <button class="intro-toggle" type="button" aria-expanded="false" aria-controls="intro-content">Mostrar m√°s</button>
  </div>

  <label for="demanda">Participaci√≥n de las optativas en la demanda (m√°x. 25%):</label>
  <input type="range" id="demanda" min="0" max="0.25" step="0.01" value="0.10">
  <div class="range-value">Valor actual: <span id="valorDemanda">0.10</span></div>

  <label for="estudiantes">Cantidad de estudiantes en el tramo de elecci√≥n libre:</label>
  <input type="number" id="estudiantes" placeholder="Ej: 200" min="0">

  <label for="optativas">Cantidad de materias optativas ofertadas:</label>
  <input type="number" id="optativas" placeholder="Ej: 5" min="1">

  <button id="calcularBtn">Calcular</button>

  <div class="resultados" id="resultados">
    <div class="resultado-item">Total de estudiantes que cursar√°n optativas: <strong id="totalEstudiantes">-</strong></div>
    <div class="resultado-item">Estudiantes por cada optativa: <strong id="porOptativa">-</strong></div>
    <div id="alertaInsustentable" class="insustentable" style="display:none;">
      ‚ö†Ô∏è Esquema insustentable: menos de 4 estudiantes por materia. La reforma no es "con todos adentro".
    </div>
  </div>

  <div class="footer-link">
    <a href="https://drive.google.com/file/d/1w-ocm-7xPLDhRhZFJyw7mOUXpUoL5Uc0/view?usp=sharing" target="_blank">
      ¬øC√≥mo fue construida esta calculadora? Apartado metodol√≥gico aqu√≠ ‚Üí
    </a>
  </div>

  <!-- === ENCUESTAS con Firebase === -->
  <section id="encuestas">
    <h2 style="text-align:center;">üìä Encuesta interactiva</h2>
    <p style="text-align:center; max-width:600px; margin:0 auto 40px;">
      Particip√° respondiendo tres preguntas sobre el nuevo plan de estudios. Los resultados se actualizan en tiempo real.
    </p>

    <div class="pregunta">
      <h3>¬øCrees que el nuevo plan de estudios no excluir√° a ninguna c√°tedra?</h3>
      <div class="botones">
        <button data-pregunta="pregunta1" data-opcion="si">S√≠</button>
        <button data-pregunta="pregunta1" data-opcion="no">No</button>
      </div>
      <canvas id="grafico1" width="300" height="300"></canvas>
      <p id="porcentajes1" class="porcentajes">Cargando...</p>
      <p id="total1" class="total-respuestas"></p>
    </div>

    <div class="pregunta">
      <h3>¬øQuer√©s que las t√©cnicas de investigaci√≥n inform√°ticas est√©n en una <em>M√©todo 4</em> o que sean parte de los contenidos m√≠nimos de las ya existentes <em>M√©todo 1, 2 y 3</em>?</h3>
      <div class="botones">
        <button data-pregunta="pregunta2" data-opcion="si">M√©todo 4</button>
        <button data-pregunta="pregunta2" data-opcion="no">Incluirlas en M√©todo 1, 2 y 3</button>
      </div>
      <canvas id="grafico2" width="300" height="300"></canvas>
      <p id="porcentajes2" class="porcentajes">Cargando...</p>
      <p id="total2" class="total-respuestas"></p>
    </div>

    <div class="pregunta">
      <h3>¬øEst√°s a favor de que Epistemolog√≠a se pueda cursar sin haber cursado Filosof√≠a?</h3>
      <div class="botones">
        <button data-pregunta="pregunta3" data-opcion="si">S√≠</button>
        <button data-pregunta="pregunta3" data-opcion="no">No</button>
      </div>
      <canvas id="grafico3" width="300" height="300"></canvas>
      <p id="porcentajes3" class="porcentajes">Cargando...</p>
      <p id="total3" class="total-respuestas"></p>
    </div>

    <p style="text-align:center; margin-top:30px; color:#555; font-size:0.9em;">
      *Exigimos a la gesti√≥n una consulta popular no v√≠nculante desagregada por bloques v√≠a SIU Guaran√≠*
    </p>
  </section>

  <!-- === Scripts === -->
  <script>
    const demandaInput = document.getElementById("demanda");
    const valorDemanda = document.getElementById("valorDemanda");
    const calcularBtn = document.getElementById("calcularBtn");
    const totalEstudiantesEl = document.getElementById("totalEstudiantes");
    const porOptativaEl = document.getElementById("porOptativa");
    const alertaInsustentable = document.getElementById("alertaInsustentable");

    demandaInput.addEventListener("input", () => {
      valorDemanda.textContent = Number(demandaInput.value).toFixed(2);
    });

    calcularBtn.addEventListener("click", () => {
      const D = parseFloat(demandaInput.value);
      const E = parseFloat(document.getElementById("estudiantes").value);
      const A = parseFloat(document.getElementById("optativas").value);

      if (isNaN(E) || isNaN(A) || A <= 0) {
        alert("Por favor, complet√° todos los campos con valores v√°lidos.");
        return;
      }

      const total = D * E;
      const porOptativa = total / A;

      totalEstudiantesEl.textContent = total.toFixed(2);
      porOptativaEl.textContent = porOptativa.toFixed(2);

      if (porOptativa < 4) {
        alertaInsustentable.style.display = "block";
        document.body.classList.add('alert-bg-animating');
        if (window.__alertBgTimer) clearTimeout(window.__alertBgTimer);
        window.__alertBgTimer = setTimeout(() => {
          document.body.classList.remove('alert-bg-animating');
          window.__alertBgTimer = null;
        }, 10000);
      } else {
        alertaInsustentable.style.display = "none";
        if (window.__alertBgTimer) clearTimeout(window.__alertBgTimer);
        document.body.classList.remove('alert-bg-animating');
      }
    });
  </script>

  <script>
    (function () {
      var wrapper = document.querySelector('.intro-collapsible');
      if (!wrapper) return;
      var btn = wrapper.querySelector('.intro-toggle');
      function isExpanded() { return wrapper.getAttribute('data-expanded') === 'true'; }
      btn.addEventListener('click', function () {
        var next = !isExpanded();
        wrapper.setAttribute('data-expanded', next ? 'true' : 'false');
        btn.setAttribute('aria-expanded', String(next));
        btn.textContent = next ? 'Mostrar menos' : 'Mostrar m√°s';
      });
    })();
  </script>

  <!-- === Firebase y Encuestas === -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC83iiDELDUZxuCEw6d-GwyTu2myQXb88g",
      authDomain: "encuesta-optativas.firebaseapp.com",
      databaseURL: "https://encuesta-optativas-default-rtdb.firebaseio.com",
      projectId: "encuesta-optativas",
      storageBucket: "encuesta-optativas.firebasestorage.app",
      messagingSenderId: "522217425445",
      appId: "1:522217425445:web:1d026462b42666cf530dcc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Variable global para la funci√≥n votar
    window.votar = async function(pregunta, opcion) {
      const clave = `yaVoto_${pregunta}`;
      if (localStorage.getItem(clave) === "true") {
        alert("Ya votaste en esta pregunta. Gracias por participar.");
        return;
      }

      try {
        const refVoto = ref(db, `votos/${pregunta}/${opcion}`);
        const snapshot = await get(refVoto);
        const actual = snapshot.exists() ? snapshot.val() : 0;
        await set(refVoto, actual + 1);
        localStorage.setItem(clave, "true");
        console.log(`Voto registrado: ${pregunta} - ${opcion}`);
      } catch (error) {
        console.error("Error al votar:", error);
        alert("Hubo un error al registrar tu voto. Intenta nuevamente.");
      }
    }

    // Asignar event listeners a los botones
    document.addEventListener('DOMContentLoaded', function() {
      const botonesVotar = document.querySelectorAll('.botones button');
      botonesVotar.forEach(boton => {
        boton.addEventListener('click', function() {
          const pregunta = this.getAttribute('data-pregunta');
          const opcion = this.getAttribute('data-opcion');
          if (pregunta && opcion) {
            window.votar(pregunta, opcion);
          }
        });
      });
    });

    onValue(ref(db, "votos"), (snapshot) => {
      const data = snapshot.val() || {};
      console.log("Datos recibidos de Firebase:", data);
      dibujarTodos({
        pregunta1: data.pregunta1 || { si: 0, no: 0 },
        pregunta2: data.pregunta2 || { si: 0, no: 0 },
        pregunta3: data.pregunta3 || { si: 0, no: 0 },
      });
    }, (error) => {
      console.error("Error al leer datos de Firebase:", error);
    });

    function dibujarGrafico(canvasId, data, porcentajesId, totalId, color1, color2) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) {
        console.error(`Canvas no encontrado: ${canvasId}`);
        return;
      }
      
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const centroX = canvas.width / 2;
      const centroY = canvas.height / 2;
      const radio = Math.min(centroX, centroY) - 10;
      
      const si = data.si || 0;
      const no = data.no || 0;
      const total = si + no;

      // Solo dibujar si hay votos
      if (total > 0) {
        const anguloSi = (si / total) * 2 * Math.PI;

        // Dibujar sector "S√≠"
        ctx.beginPath();
        ctx.moveTo(centroX, centroY);
        ctx.arc(centroX, centroY, radio, 0, anguloSi);
        ctx.closePath();
        ctx.fillStyle = color1;
        ctx.fill();

        // Dibujar sector "No"
        ctx.beginPath();
        ctx.moveTo(centroX, centroY);
        ctx.arc(centroX, centroY, radio, anguloSi, 2 * Math.PI);
        ctx.closePath();
        ctx.fillStyle = color2;
        ctx.fill();
      } else {
        // Dibujar c√≠rculo gris si no hay votos
        ctx.beginPath();
        ctx.arc(centroX, centroY, radio, 0, 2 * Math.PI);
        ctx.fillStyle = '#f0f0f0';
        ctx.fill();
      }

      // Actualizar porcentajes
      const porcentajeSi = total > 0 ? ((si / total) * 100).toFixed(1) : "0.0";
      const porcentajeNo = total > 0 ? ((no / total) * 100).toFixed(1) : "0.0";
      
      const porcentajesElement = document.getElementById(porcentajesId);
      if (porcentajesElement) {
        porcentajesElement.textContent = `S√≠: ${porcentajeSi}% | No: ${porcentajeNo}%`;
      }

      // Actualizar total de respuestas
      const totalElement = document.getElementById(totalId);
      if (totalElement) {
        if (total === 0) {
          totalElement.textContent = "A√∫n no hay respuestas";
        } else {
          totalElement.textContent = `Total de respuestas: ${total}`;
        }
      }
    }

    function dibujarTodos(data) {
      dibujarGrafico("grafico1", data.pregunta1, "porcentajes1", "total1", "#28a745", "#dc3545");
      dibujarGrafico("grafico2", data.pregunta2, "porcentajes2", "total2", "#007bff", "#f0ad4e");
      dibujarGrafico("grafico3", data.pregunta3, "porcentajes3", "total3", "#6f42c1", "#dc3545");
    }

    // Dibujar gr√°ficos iniciales con datos vac√≠os
    dibujarTodos({
      pregunta1: { si: 0, no: 0 },
      pregunta2: { si: 0, no: 0 },
      pregunta3: { si: 0, no: 0 }
    });
  </script>
</body>
</html>

